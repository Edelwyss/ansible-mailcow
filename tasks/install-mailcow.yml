---
### Download, configure and install mailcow-dockerized.

- name: Clone mailcow repo.
  git:
    repo: https://github.com/mailcow/mailcow-dockerized
    version: master
    dest: "{{ mc_install_dir }}"
    clone: yes
    update: yes
    force: yes

- name: Prevent asking for interactive input in generate_config.sh by removing read prompts.
  replace:
    path: "{{ mc_install_dir }}/generate_config.sh"
    regexp: "^[\t ]*read -p"
    replace: "  : #read -p"
    backup: yes

# intermittently the script uses the busybox version of grep and fails, thus force bash
- name: Generate mailcow configuration (only runs once).
  shell: ./generate_config.sh
  args:
    executable: /bin/bash
    chdir: /opt/mailcow-dockerized/
    creates: "{{ mc_install_dir }}/mailcow.conf"
  environment:
    MAILCOW_HOSTNAME: "{{ mc_fqdn }}"

# the TZ environment variable isn't used by generate_config.sh, thus set it here.
- name: Insert timezone into mailcow.conf.
  lineinfile:
    path: "{{ mc_install_dir }}/mailcow.conf"
    regexp: "^TZ="
    line: "TZ={{ mc_timezone }}"
    state: present

- name: Insert additional subdomains into mailcow.conf for SSL certificate generation.
  lineinfile:
    path: "{{ mc_install_dir }}/mailcow.conf"
    regexp: "^ADDITIONAL_SAN"
    line: "ADDITIONAL_SAN={{ mc_nextcloud_subdomain }}.{{ mc_domain }}"
    state: present

- name: Insert watchdog notify email into mailcow.conf.
  lineinfile:
    path: "{{ mc_install_dir }}/mailcow.conf"
    regexp: "^#WATCHDOG_NOTIFY_EMAIL="
    line: "WATCHDOG_NOTIFY_EMAIL={{ mc_notify_email }}"
    state: present

# TODO: (optional)
#  Modify docker-compose to add a bind mount for Nextcloud with s3ql

- name: Pull docker images & start containers (WAIT a few minutes).
  docker_service:
    project_src: "{{ mc_install_dir }}"
    pull: yes
    state: present # equivalent to docker-compose up
